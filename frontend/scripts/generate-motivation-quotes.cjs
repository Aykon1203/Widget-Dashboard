const fs = require('fs')
const path = require('path')

// Locate package installation and require the lib
function loadMotivation() {
  try {
    const pkg = require('motivation')
    return pkg
  } catch (e) {
    try {
      const pkgPath = require.resolve('motivation')
      return require(pkgPath)
    } catch (err) {
      throw err
    }
  }
}

function generate() {
  const outFile = path.join(__dirname, '..', 'src', 'services', 'motivation-quotes.ts')
  let quotes = []
  try {
    const mod = loadMotivation()
    const inst = mod?.default ?? mod
    if (inst && typeof inst.getAll === 'function') {
      quotes = inst.getAll()
    } else if (Array.isArray(inst)) {
      quotes = inst
    } else if (typeof inst.get === 'function') {
      const set = new Set()
      for (let i = 0; i < 100 && set.size < 100; i++) {
        try { set.add(JSON.stringify(inst.get())) } catch (e) {}
      }
      quotes = Array.from(set).map(s => JSON.parse(s))
    }
  } catch (err) {
    console.warn('generate-motivation-quotes: failed to read motivation package, using minimal fallback', err && err.message)
  }

  const normalized = (Array.isArray(quotes) ? quotes : []).map(q => {
    if (!q) return null
    if (typeof q === 'string') return { text: q }
    return { text: q.text ?? q.quote ?? q.body ?? '', author: q.author ?? q.by ?? '' }
  }).filter(Boolean)

  const content = `// Generated by scripts/generate-motivation-quotes.cjs â€” do not edit\nexport default ${JSON.stringify(normalized, null, 2)}\n`

  fs.mkdirSync(path.dirname(outFile), { recursive: true })
  fs.writeFileSync(outFile, content, 'utf8')
  console.log('Wrote', outFile, 'with', normalized.length, 'quotes')
}

if (require.main === module) {
  generate()
}

module.exports = { generate }
